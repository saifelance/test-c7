(self.webpackChunkmp_webgl=self.webpackChunkmp_webgl||[]).push([[983],{59855:(e,t,s)=>{"use strict";s.d(t,{t:()=>a});var i=s(17597),o=s(20331),r=s(60771),n=s(17916);const a={urlTemplateToken:"<file>",hideMenu:"1"!==(0,i.eY)("dmenu","0"),debug:"1"===(0,i.eY)("debugTiles","0"),displayBoxBounds:!1,initialMaxLOD:0,maxLOD:(0,i.eY)("maxLOD",n.V.High),loadSiblings:!0,displayActiveTiles:!1,autoDisableRendererCulling:!0,optimizeRaycast:!1,stopAtEmptyTiles:!1,statsTiles:!0,statsTextures:!1,statsTextureStream:!1,errorTarget:Number((0,i.eY)("errorTarget",4)),disableTileUpdates:!1,errorMultiplierRaycastOcclusion:.1,errorMultiplierHiddenFloors:.01,disposeModel:!1,limitMemoryUsage:(0,r.tq)(),allocatedMegsBeforeLimitingLod:350,lruMinExtraTiles:(0,r.tq)()?0:100,lruMaxTiles:800,lruUnloadPercent:.05,tileAssetRequestPriority:o.RequestPriority.MEDIUM,downloadQueueConcurrency:8,parseQueueConcurrency:10,snappingMaxLOD:n.V.Standard}},12626:(e,t,s)=>{"use strict";s.r(t),s.d(t,{createModelMesh:()=>J});var i=s(96909),o=s(59088),r=s(26128),n=s(15443),a=s(2212),l=s(67790),d=s(2388),h=s(17915),u=s(6559),c=s(93331),m=s(62955),p=s(21922),g=s(51245),T=s(88512),f=s(41038),M=s(91283),L=s(59855),v=s(44283),y=s(80122),x=s(17916);class MttrDownloadQueue extends y.Z{constructor(e,t,s,i){super(),this.urlSigner=e,this.modelUrls=t,this.onProgress=i,this.priorityCallback=s}add(e,t){return super.add(e,(async e=>{var s,i,o;if(null===(s=null==e?void 0:e.content)||void 0===s?void 0:s.uri){const s=e.content.uri;try{const r=null===(i=this.onProgress)||void 0===i?void 0:i.bind(this,e);if(e.content.uri=await this.urlSigner(s),(null===(o=e.extras)||void 0===o?void 0:o.level)===x.V.Min)return t(e).then((e=>r?function(e,t){if(e.ok&&e.body){const s=e.body.getReader(),i=e.headers.get("Content-Length");let o=i?+i:0,r=0!==o,n=0;const a=new ReadableStream({async start(e){for(;;){const{done:i,value:a}=await s.read();if(a&&(n+=a.byteLength,e.enqueue(a)),i&&(o=n,r=!0),null==t||t(new ProgressEvent("progress",{lengthComputable:r,loaded:n,total:o})),i){e.close();break}}}});e=new Response(a)}return e}(e,r):e));{const s=window.fetch;try{return window.fetch=async(e,t)=>{const s=await this.modelUrls.getFile(e,{responseType:"blob",priority:L.t.tileAssetRequestPriority,onProgress:r,signal:null==t?void 0:t.signal});return new Response(s)},t(e)}finally{window.fetch=s}}}finally{e.content.uri=s}}}))}}var w=s(19131);var b=s(84561),S=s(96367);class MTTRMeshBvh{constructor(e){this.parser=e,this.name="MTTR_three_mesh_bvh"}async loadMesh(e){const t=async(t,s)=>{var i,o;const r=this.parser.json.meshes[e].primitives[s];if(null===(i=r.extensions)||void 0===i?void 0:i.MTTR_three_mesh_bvh){const e=null===(o=r.extensions)||void 0===o?void 0:o.MTTR_three_mesh_bvh,s={roots:(await Promise.all(e.roots.map((e=>this.parser.loadAccessor(e))))).map((e=>{const t=e.array;return t.byteLength!==t.buffer.byteLength?t.slice().buffer:t.buffer})),index:new Uint8Array(0)};t.geometry.boundsTree=S.r.deserialize(s,t.geometry,{setIndex:!1})}},s=[],i=await this.loadMeshInternal(e);if(i)if("Group"===i.type){const e=i;s.push(...e.children.map(((e,s)=>t(e,s))))}else"Mesh"===i.type&&s.push(t(i,0));return await Promise.all(s),i}async loadMeshInternal(e){const t=this.parser,s=t,i=this.parser.json.meshes[e],o=i.primitives,r=[];for(let e=0,i=o.length;e<i;e++){const i=void 0===o[e].material?t.createDefaultMaterial(s.cache):t.getDependency("material",o[e].material);r.push(i)}return r.push(t.loadGeometries(o)),Promise.all(r).then((function(s){const r=s.slice(0,s.length-1),n=s[s.length-1],l=[];for(let s=0,a=n.length;s<a;s++){const a=n[s],d=o[s];let h;const u=r[s];if(d.mode!==C.TRIANGLES&&void 0!==d.mode)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);h=new p.g(0,0,b.o.DEFAULT),h.geometry=a,h.material=u,h.name=t.createUniqueName(i.name||"mesh_"+e),R(h,i),t.assignFinalMaterial(h),l.push(h)}if(1===l.length)return l[0];const d=new a.Group;for(let e=0,t=l.length;e<t;e++)d.add(l[e]);return d}))}}const C={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123};function R(e,t){void 0!==t.extras&&"object"==typeof t.extras&&Object.assign(e.userData,t.extras)}var _=s(10338),k=s(17047);class CrossModelTextureCache{constructor(e){this.parser=e,this.name="CrossModelTextureCache"}static addToLoader(e){e.pluginCallbacks.unshift((e=>new CrossModelTextureCache(e)))}loadTexture(e){var t;const s=this.parser,i=s.json,o=i.textures[e];let r=o.source;Object.keys(o.extensions).forEach((e=>r=r||o.extensions[e].source));const n=null===(t=i.images[r])||void 0===t?void 0:t.uri;if(void 0===n)return null;const a=E.get(n);if(a)return a;let l=s._invokeOne((t=>t===this?null:t.loadTexture&&t.loadTexture(e)));l||(l=s.loadTexture(e));const d=l.then((e=>{const t=()=>{E.delete(n),null==e||e.removeEventListener("dispose",t)};return null==e||e.addEventListener("dispose",t),e}));return E.set(n,d),d}}const E=new Map;var D=s(69138);let A,F;function U(e,t,s,i){return A||(A=new MttrKTX2Loader(s,i),A.setTranscoderPath("libs/three@0.134.0/basis/"),A.detectSupport(e),A.manager=t,A.preload(),A)}class MttrKTX2Loader extends D.KTX2Loader{constructor(e,t){super(),this.urlSigner=e,this.modelUrls=t,this.taskCache=new WeakMap}load(e,t,s,i){const o=new a.CompressedTexture([],0,0);return this.urlSigner(e).then((async e=>{const i=await this.modelUrls.getFile(e,{onProgress:s,responseType:"arraybuffer",priority:L.t.tileAssetRequestPriority});let r=this.taskCache.get(i);if(!r){r={promise:this._createTexture([i])},this.taskCache.set(i,r)}const n=await r.promise;o.copy(n),o.needsUpdate=!0,t(o)})).catch(i),o}preload(){this.init()}}var O,P=s(67502),I=s(64185),B=s(62330);class MttrParseQueue extends y.Z{constructor(){super(...arguments),this.prioritizeBy=O.FRUSTUM_ERROR_THRESH,this.priorityCallback=(e,t)=>{switch(this.prioritizeBy){case O.FRUSTUM_ERROR_THRESH:return this.sortBySelectors(e,t,[e=>Number(e.__inFrustum),e=>Number(e.__error<=L.t.errorTarget),e=>e.__error,e=>e.__distanceFromCamera]);default:return this.defaultPriorityCallback(e,t)}}}sortBySelectors(e,t,s){for(const i of s){const s=this.compareTile(e,t,i);if(null!==s)return s}return 0}compareTile(e,t,s){const i=s(e),o=s(t);return i===o?null:i>o?1:-1}defaultPriorityCallback(e,t){return e.__depth!==t.__depth?e.__depth>t.__depth?-1:1:e.__inFrustum!==t.__inFrustum?e.__inFrustum?1:-1:e.__used!==t.__used?e.__used?1:-1:e.__error!==t.__error?e.__error>t.__error?1:-1:e.__distanceFromCamera!==t.__distanceFromCamera?e.__distanceFromCamera>t.__distanceFromCamera?-1:1:0}}!function(e){e.DEFAULT="DEFAULT",e.FRUSTUM_ERROR_THRESH="FRUSTUM_ERROR_THRESH"}(O||(O={}));const z=new T.Z("tiled-mesh"),V=(M.Jk,M.br,M.yX,M.tE);M.ig;class MttrTileLoader{constructor(e,t,s,i,o,r){this.container=e,this.chunkFactory=s,this.tilesetInfo=i,this.commandBinder=o,this.modelUrls=r,this.name="MttrTileLoader",this.loadStats={startTimes:{start:0,tileset:0,texinfo:0,lod0:0,lod1:0},timings:{tileset:"",texinfo:"",lod0:"",lod1:""}},this.lodDeferreds=[],this.tileProgress=new WeakMap,this.onChunksLoaded=new Set,this.onChunksUnloaded=new Set,this.tileSetLoaded=!1,this.minimalLoaded=!1,this.minimalTileCount=0,this.signUrl=async e=>{if(e.startsWith("blob"))return e;return(await this.tilesetInfo.urlTemplate.get()).replace(L.t.urlTemplateToken,e)},this.onTileDownloadProgress=(e,t)=>{this.tileProgress.set(e,t.lengthComputable?t.loaded/t.total:0),this.checkLoadStatus()},this.checkLoadStatus=(()=>{const e=[];let t=!1,s=!1;return(0,B.P)((()=>{t&&s||!this.tileSetLoaded||(0===e.length&&(e.push([],[]),this.tilesRenderer.traverse(((t,s,i)=>{var o;const r=null===(o=t.extras)||void 0===o?void 0:o.level;return 0!==r&&1!==r||e[r].push(t),!1}),null)),t||(t=this.notifyIfFullyLoaded(0,e,!0),t&&(z.debug("LOD0 fully downloaded, allow showing more lods"),this.minimalLoaded=!0,this.minimalTileCount=e[0].length,this.loadStats.timings.lod0=(performance.now()-this.loadStats.startTimes.lod0).toFixed(1)+"ms",this.loadStats.startTimes.lod1=performance.now())),s||(s=this.notifyIfFullyLoaded(1,e,!1),s&&(this.loadStats.timings.lod1=(performance.now()-this.loadStats.startTimes.lod1).toFixed(1)+"ms",e.length=0)))}),16)})(),this.loadStats.startTimes.start=performance.now(),this.loadStats.startTimes.texinfo=performance.now(),this.tilesRenderer=new f.I(i.rootURL);const n=function(e,t,s,i){F||(F=new _.DRACOLoader,F.setDecoderPath("libs/three@0.134.0/draco/gltf/"),F.preload());const o=new k.GLTFLoader(t);o.setDRACOLoader(F),o.register((e=>new MTTRMeshBvh(e))),CrossModelTextureCache.addToLoader(o);const r=U(e,t,s,i);return o.setKTX2Loader(r),o}(t,this.tilesRenderer.manager,this.signUrl,r);this.configureTilesRenderer(this.tilesRenderer,n)}setSize(e,t,s){this.tilesRenderer.setCamera(e),this.tilesRenderer.setResolution(e,t,s)}notifyOnChunksLoaded(e){return(0,v.k1)((()=>this.onChunksLoaded.add(e)),(()=>this.onChunksLoaded.delete(e)),!0)}notifyOnChunksUnloaded(e){return(0,v.k1)((()=>this.onChunksUnloaded.add(e)),(()=>this.onChunksUnloaded.delete(e)),!0)}notifyOnLodProgress(e,t){this.getLodDeferred(e).progress(t)}awaitLod(e){return this.getLodDeferred(e).nativePromise()}getLodDeferred(e){return this.lodDeferreds[e]||(this.lodDeferreds[e]=new I.Q)}update(){const{minimalLoaded:e,tilesRenderer:t}=this;e?(t.displayActiveTiles=L.t.displayActiveTiles,t.loadSiblings=L.t.loadSiblings,t.optimizeRaycast=L.t.optimizeRaycast,t.stopAtEmptyTiles=L.t.stopAtEmptyTiles,t.autoDisableRendererCulling=L.t.autoDisableRendererCulling,t.downloadQueue.maxJobs=L.t.downloadQueueConcurrency,t.parseQueue.maxJobs=L.t.parseQueueConcurrency):(t.loadSiblings=!0,t.downloadQueue.maxJobs=1/0,t.parseQueue.maxJobs=1/0),t.errorTarget=L.t.errorTarget,t.lruCache.maxSize=e?Math.max(L.t.lruMaxTiles,this.minimalTileCount):1/0,t.update(),t.lruCache.minSize=L.t.lruMinExtraTiles+t.lruCache.usedSet.size,t.lruCache.unloadPercent=L.t.lruUnloadPercent}getDownloadParseStatus(){return this.tilesRenderer.stats}configureTilesRenderer(e,t){const s=e.calculateError.bind(e);e.calculateError=e=>{s(e),this.adjustScreenSpaceError&&(e.__error=this.adjustScreenSpaceError(e.__error,e))},e.manager.addHandler(/\gltf$/,t),e.manager.addHandler(/\glb$/,t),e.errorTarget=L.t.errorTarget,e.loadSiblings=L.t.loadSiblings,e.stopAtEmptyTiles=L.t.stopAtEmptyTiles,e.displayActiveTiles=L.t.displayActiveTiles;const i=e.preprocessNode.bind(e);e.preprocessNode=function(e,t,s){return i(e,t,"")},this.configurePriorityQueues(),this.container.add(e.group);const o=(new a.Quaternion).setFromAxisAngle(new a.Vector3(-1,0,0),a.MathUtils.degToRad(90));this.container.quaternion.copy(o),this.container.updateMatrixWorld(!0),e.onLoadTileSet=this.onLoadTileset.bind(this),e.onLoadModel=this.onLoadModel.bind(this),e.onDisposeModel=this.onDisposeModel.bind(this);const r=e.setTileActive.bind(e);e.setTileActive=(e,t)=>{r(e,t),this.onTileActiveChange&&this.onTileActiveChange(e,t)};const n=e.setTileVisible.bind(e);e.setTileVisible=(e,t)=>{n(e,t),this.onTileVisibleChange&&this.onTileVisibleChange(e,t)};const l=e.tileInView.bind(e);e.tileInView=e=>{var t;let s=-1;for(let i=e.parent;i;i=i.parent){const e=null===(t=i.extras)||void 0===t?void 0:t.level;if("number"==typeof e){s=e;break}}return!(s>=(this.minimalLoaded?L.t.maxLOD:L.t.initialMaxLOD))&&l(e)}}configurePriorityQueues(){const{tilesRenderer:e}=this;e.downloadQueue=new MttrDownloadQueue(this.signUrl,this.modelUrls,e.downloadQueue.priorityCallback,this.onTileDownloadProgress),e.parseQueue=new MttrParseQueue;const t=e=>{this.commandBinder.issueCommand(new P._("mesh/tiled/priorityQueue",e,100))};e.parseQueue.schedulingCallback=t,e.downloadQueue.schedulingCallback=t}async onLoadModel(e,t){const s=function(e,t,s){var i;const o=[],r=(null===(i=t.extras)||void 0===i?void 0:i.id)||""+e.id;return e.name=r,e.traverse((e=>{var i;if(e.matrixAutoUpdate=!1,e.updateMatrix(),e.updateMatrixWorld(),e instanceof p.g){const{group:n,subgroup:a,chunkIndex:l}=(0,w.xc)(`${r}-${e.name}`),d=e.material,h=d.map;let u=null==h?void 0:h.name;u||(u=d.name.replace(".jpg",""));const c=s(n,a,e.geometry,u);c.textureLODInfo=function(e,t){if(t&&(null==t?void 0:t.maxTextureSize)&&(null==t?void 0:t.texelSize)&&(null==t?void 0:t.textureScale)&&t.textureScale>0){const s=t.textureScale;return{name:e,maxTexelSize:.001*t.texelSize,maxTextureSize:t.maxTextureSize,minTexelSize:1/s*t.texelSize*.001,minTextureSize:s*t.maxTextureSize,minScale:s}}return null}(u,t.extras)||void 0,c.lod=(null===(i=t.extras)||void 0===i?void 0:i.level)||0,c.chunkIndex=l,c.notifyOnMaterialUpdated((t=>{e.material=t}));const m={};m.map=h,e.buildWithTileChunk(c),e.material=c.setMaterialsUniform(m),c.name=e.name,c.embeddedTexture=m.map,o.push(c)}})),o}(e,t,this.chunkFactory);for(const e of s)this.container.addChunk(e);for(const e of this.onChunksLoaded.values())e(s,t);this.onModelLoaded&&this.onModelLoaded(e,t),await new Promise((e=>setTimeout(e,0))),this.checkLoadStatus()}onDisposeModel(e,t){e.traverse((e=>{if((0,g.oR)(e)){const s=e.chunks;if(!s)return void z.error("Missing chunks from RoomMesh");for(const e of s)this.container.removeChunk(e);for(const e of this.onChunksUnloaded.values())e(s,t)}})),this.onModelUnloaded&&this.onModelUnloaded(e,t),e.traverse((e=>{(0,g.oR)(e)&&e.reset()}))}onLoadTileset(e,t){var s;const i=!this.loadStats.startTimes.lod0;let o="";i&&(o=(performance.now()-this.loadStats.startTimes.start).toFixed(1),this.loadStats.timings.tileset=o+"ms");const r=null===(s=t.match(/[^/]*\.json/))||void 0===s?void 0:s[0];z.debug(`Tileset ${r} load${i?`: ${o}ms`:""}`,e),i&&(this.loadStats.startTimes.lod0=performance.now()),this.tileSetLoaded=!0,this.onTilesetLoaded(e,t),this.tilesRenderer.update()}notifyIfFullyLoaded(e,t,s){if(!t[e])return!1;const i=t[e],o=i.filter((e=>e.__loadingState!==V)),r=this.getLodDeferred(e);return s&&r.notify(i.reduce(((e,t)=>e+(this.tileProgress.get(t)||0)/i.length),0)),0===o.length&&r.resolve(),0===o.length}}const Q=new a.Vector3,N=(new a.Matrix4).set(1,0,0,0,0,0,-1,0,0,1,0,0,0,0,0,1),H=N.clone().invert();function G(e,t){if(!1!==t(e)&&e.children)for(const s of e.children)G(s,t)}function j(e,t){const{box:s,boxTransformInverse:i}=function(e){let t=W.get(e);if(!t){const s=e.boundingVolume.box,i=new a.Box3,o=new a.Matrix4,r=new a.Vector3(s[3],s[4],s[5]),n=new a.Vector3(s[6],s[7],s[8]),l=new a.Vector3(s[9],s[10],s[11]),d=r.length(),h=n.length(),u=l.length();r.normalize(),n.normalize(),l.normalize(),0===d&&r.crossVectors(n,l),0===h&&n.crossVectors(r,l),0===u&&l.crossVectors(r,n),o.set(r.x,n.x,l.x,s[0],r.y,n.y,l.y,s[1],r.z,n.z,l.z,s[2],0,0,0,1).invert(),i.min.set(-d,-h,-u),i.max.set(d,h,u),t={box:i,boxTransformInverse:o},W.set(e,t)}return t}(t);return Q.copy(e).applyMatrix4(N).applyMatrix4(i),s.containsPoint(Q)}const W=new WeakMap;const q=new T.Z("streamed-mesh");class ModelMeshTiled extends m.e{constructor(e){super(),this.uuid=e,this.boundingBox=new a.Box3,this.size=new a.Vector3,this.center=new a.Vector3,this.bindings=[],this.roomMeshesByTile=new Map,this.activeRoomMeshes=new Set,this.visibleRoomMeshes=new Set,this.activeTiles=new Set,this.tileActiveDescendantCounts=new WeakMap,this.tilesByChunkId=new Map,this.isActiveRoomMeshFilter=e=>this.activeRoomMeshes.has(e),this.isActiveRoomMeshSnapFilter=e=>{var t,s,i;const o=null===(t=e.meta)||void 0===t?void 0:t.tile;if(o){const{snappingMaxLOD:e}=L.t,t=null!==(i=null===(s=o.extras)||void 0===s?void 0:s.level)&&void 0!==i?i:1/0;if(t===e&&(this.tileActiveDescendantCounts.get(o)||0)>0||t<=e&&this.activeTiles.has(o))return!0}return!1}}dispose(){this.bindings.forEach((e=>e.cancel())),this.bindings=[]}async load(e,t,s,i,o,a,h,u,m){this.renderer=t,a.root=this,this.tileLoader=new MttrTileLoader(this,t.threeRenderer,h,o,e.commandBinder,m),this.tileLoader.onTilesetLoaded=e=>{var t;(null===(t=e.extras)||void 0===t?void 0:t.mpVersion)||(q.error("Deprecated pre-beta tileset, this *WILL* break in a future update. Reprocess with streamed-mesh enabled"),d.EJ.legacyTexturesMax=!0)},this.tileLoader.setSize(s,i.width,i.height),this.bindings.push(e.subscribe(l.a,(e=>{this.tileLoader.setSize(s,e.width,e.height)}))),this.tileLoader.onModelLoaded=(e,t)=>{let s=this.roomMeshesByTile.get(t);s||(s=[],this.roomMeshesByTile.set(t,s)),e.traverse((e=>{(0,g.oR)(e)&&(a.rooms.add(e),s.push(e),this.inputIni&&this.registerMeshForCollision(this.inputIni,e,t))})),a.commit()},this.tileLoader.onModelUnloaded=(e,t)=>{e.traverse((e=>{e instanceof p.g&&(a.rooms.delete(e),this.inputIni&&this.unregisterMeshFromCollision(this.inputIni,e))})),a.commit(),this.tileLoader.onTileActiveChange(t,!1),this.tileLoader.onTileVisibleChange(t,!1),this.roomMeshesByTile.delete(t)},this.tileLoader.onTileActiveChange=(e,t)=>{var s;const i=t?"add":"delete";null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.activeRoomMeshes[i](e)})),this.activeTiles[i](e);for(let s=e.parent;s;s=s.parent){const e=this.tileActiveDescendantCounts.get(s)||0;this.tileActiveDescendantCounts.set(s,e+(t?1:-1))}},this.tileLoader.onTileVisibleChange=(e,t)=>{var s;null===(s=this.roomMeshesByTile.get(e))||void 0===s||s.forEach((e=>{this.visibleRoomMeshes[t?"add":"delete"](e)}))},this.initTileLodAdjustments(this.tileLoader,u),this.tileLoader.notifyOnLodProgress(0,(t=>{e.broadcast(new c.Z(t,1))})),this.tileLoader.update(),await this.tileLoader.awaitLod(0),this.tileLoader.tilesRenderer.getBounds(this.boundingBox),this.boundingBox.applyMatrix4(H),this.boundingBox.getSize(this.size),this.boundingBox.getCenter(this.center),e.broadcast(new r.em(n.Y.StreamingMesh)),e.broadcast(new r.em(n.Y.StreamingTexture))}initTextureLoader(e,t){return(0,u.qT)().limitStreamingBelow(d.EJ.disableTextureStreamBelowLod),e.autoLoadTiles=!1,e.setModel(this,this._chunks,t,(()=>L.t.limitMemoryUsage?L.t.allocatedMegsBeforeLimitingLod*2**20:1/0)),this.bindings.push(this.tileLoader.notifyOnChunksLoaded((t=>{e.addChunkSlots(t);for(const e of this.onChunksLoaded.values())e(t)})),this.tileLoader.notifyOnChunksUnloaded((t=>{e.removeChunks(t)}))),e.allowTextureDownload=()=>{const{downloading:e,parsing:t}=this.tileLoader.getDownloadParseStatus();return 0===e&&0===t},Promise.resolve()}initTileLodAdjustments(e,t){const s=this.tilesByChunkId,i=new Map;let o=0;this.bindings.push(e.notifyOnChunksLoaded(((e,t)=>{for(const i of e)s.set(i.id,t)})),t.notifyOnNewSighting(((e,t)=>{o++;const r=s.get(e.id);if(r){for(let e=r.parent;e;e=e.parent)i.set(e,o);G(r,(e=>!(e!==r&&!j(t.point,e))&&(i.set(e,o),!0)))}})),this.tileLoader.notifyOnChunksUnloaded((e=>{for(const t of e)s.delete(t.id),t.dispose()}))),e.adjustScreenSpaceError=(e,t)=>{var s,r;if(1!==L.t.errorMultiplierRaycastOcclusion){(null!==(s=i.get(t))&&void 0!==s?s:-1/0)<o-d.EJ.sightingMaxAge&&(e*=L.t.errorMultiplierRaycastOcclusion)}if(1!==L.t.errorMultiplierHiddenFloors){(null===(r=this.roomMeshesByTile.get(t))||void 0===r?void 0:r.some((e=>e.chunks.some((e=>e.getOpacity()>d.xx.FADE_DEPTH_WRITE_THRESHOLD)))))||(e*=L.t.errorMultiplierHiddenFloors)}return e}}registerCollision(e){this.inputIni=e,this.tileLoader.tilesRenderer.forEachLoadedModel(((t,s)=>{t.traverse((t=>{(0,g.oR)(t)&&this.registerMeshForCollision(e,t,s)}))}))}registerMeshForCollision(e,t,s){e.registerMesh(t,!0,this.isActiveRoomMeshFilter),t.chunks[0].lod<=L.t.snappingMaxLOD&&e.registerSnappingMeshGeometry(t.name,t.geometry,{tile:s},this.isActiveRoomMeshSnapFilter)}unregisterMeshFromCollision(e,t){e.unregisterMesh(t),e.unregisterSnappingMeshGeometry(t.name)}addChunk(e){this._chunks.push(e)}removeChunk(e){const t=this._chunks.indexOf(e);this._chunks.splice(t,1)}onUpdate(){L.t.disableTileUpdates||(this.tileLoader.update(),this.checkDispose());const e=L.t.maxLOD;if(this.renderer.estimatedGPUMemoryAllocated()>2**20*(L.t.limitMemoryUsage?L.t.allocatedMegsBeforeLimitingLod:1/0)&&L.t.maxLOD>0&&L.t.maxLOD--,L.t.maxLOD!==e){const e=Math.min(L.t.maxLOD,d.EJ.disableTextureStreamBelowLod);(0,u.qT)().limitStreamingBelow(e)}}setTextureQuality(e,t,s){e.setQuality(u.S7.LOW,s)}get visibleChunks(){const e=this.visibleRoomMeshes;return{*[Symbol.iterator](){for(const t of e)for(const e of t.chunks)yield e}}}checkDispose(){if(L.t.disposeModel){const e=this.tileLoader.tilesRenderer,t=e;for(const e of t.cameras)t.deleteCamera(e);const s=.001,i=new a.OrthographicCamera(-s,s,s,-s,s,2*s);i.position.set(0,-1e4,0),i.rotation.setFromVector3(new a.Vector3(0,-1,0)),i.updateMatrix(),i.updateMatrixWorld(),this.tileLoader.setSize(i,100,100),e.lruCache.minSize=0,e.lruCache.unloadPercent=1,e.lruCache.markAllUnused(),e.update(),e.dispose(),h.z.disposeShared(),L.t.disableTileUpdates=!0}}}async function J({uuid:e,engine:t,settings:s,modelData:r,roomMeshData:n,chunkFactory:a,chunkVisibilityChecker:l,urls:d}){s.flipDownload=!1,s.flipUpload=!1;const h=new ModelMeshTiled(e),[u,c]=await Promise.all([t.getModuleBySymbol(i.y.WEBGL_RENDERER),t.market.waitForData(o.M_)]);return await h.load(t,u,u.getCamera(),c,r.model.tileset,n,a,l,d),h}}}]);